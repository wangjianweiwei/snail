<script setup>
import {ref, onMounted, watch} from "vue";
import {useTheme} from 'vuetify'
import {useRoute, useRouter} from "vue-router";
import {retrievePostApi, deletePostApi, publishPostApi} from "@/services";

const theme = useTheme()
const authState = localStorage.getItem("token")
const route = useRoute()
const router = useRouter()
const postId = route.params.id
const post = ref({})
const snackbar = ref(false)
const snackbarColor = ref("primary")
const snackbarText = ref("")


onMounted(async () => {
  post.value = await retrievePostApi(postId)
  const {createOpenViewer} = window.Doc;
  // 创建阅读器
  const viewer = createOpenViewer(document.getElementById('editor'), {
    layout: "adapt",
    defaultFontsize: 15,
    darkMode: theme.global.name.value === "dark",
    toc: {
      enable: true
    },
  });
  // 设置内容
  viewer.setDocument('json', post.value.content);
  watch(() => theme.global.name.value, (newVal, oldVal) => {
    if (newVal === "dark") {
      viewer.theme.setActiveTheme("dark-mode")
    } else {
      viewer.theme.setActiveTheme("default")
    }
  })


})


async function deletePost() {
  let data = await deletePostApi(postId)
  if (data.status) {
    await router.push("/posts/list")
  } else {
    snackbarText.value = "刪除失敗"
    snackbar.value = true
  }
}

async function publishPost(status) {
  let data = await publishPostApi(postId, status)
  if (data.status) {
    post.value.published = status
    snackbarText.value = "成功"
    snackbar.value = true
  } else {
    snackbarText.value = "失败"
    snackbar.value = true
  }
}
</script>

<template>
  <div class="py-lg-5">
    <v-row justify="center" no-gutters>
      <v-col cols="11" md="6">
        <v-row class="d-flex justify-space-between align-center" dense>
          <v-col cols="12">
            <span class="text-h4 font-weight-bold">{{ post.title }}</span>
          </v-col>
        </v-row>
        <v-row class="align-center" dense>
          <v-col cols="12" md="6">
            <span class="mr-4">📅 {{ post.created_at }}</span>
            <span>🖊️ {{ post.wordcount }}字</span>
          </v-col>
          <v-col cols="12" md="6" class="mt-3">
            <div v-if="authState">
              <v-btn variant="tonal" append-icon="mdi-square-edit-outline" :to="`/posts/editor/${postId}`">编辑</v-btn>
              <span class="mx-2"></span>

              <v-btn v-if="post.published" variant="tonal" append-icon="mdi-publish-off" color="warning"
                     @click="publishPost(false)">取消发布
              </v-btn>
              <v-btn v-else variant="tonal" append-icon="mdi-publish" color="success" @click="publishPost(true)">发布
              </v-btn>

              <span class="mx-2"></span>
              <v-btn variant="tonal" append-icon="mdi-delete-alert-outline" color="error" @click="deletePost">删除
              </v-btn>
            </div>
          </v-col>
        </v-row>
        <v-divider class="mt-3"></v-divider>
        <div id="editor" class="ne-doc-major-viewer"></div>
      </v-col>
      <v-snackbar
        v-model="snackbar"
        :color="snackbarColor"
        timeout="1200"
        location="top right"
        variant="elevated"
        :text="snackbarText"
      >
      </v-snackbar>
    </v-row>
  </div>

</template>

<style>
.ne-doc-major-viewer .ne-viewer-layout-mode-adapt {
  padding: 10px 0 !important;
}

.ne-viewer-toc-sidebar {
  background: rgba(var(--v-theme-background)) !important;
}
</style>
